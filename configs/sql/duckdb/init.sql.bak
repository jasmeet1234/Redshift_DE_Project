-- DuckDB initialization schema for Redshift Query Metrics Dashboard
-- This file is safe to run multiple times (IF NOT EXISTS / CREATE OR REPLACE VIEW).

-- ------------------------------------------------------------
-- Canonical processed stream (cleaned + enriched)
-- ------------------------------------------------------------
CREATE TABLE IF NOT EXISTS query_metrics_processed (
  query_id VARCHAR NOT NULL,
  deployment_type VARCHAR NOT NULL,
  instance_id VARCHAR,
  arrival_timestamp TIMESTAMPTZ NOT NULL,
  queue_duration_ms BIGINT NOT NULL,
  compile_duration_ms BIGINT NOT NULL,
  execution_duration_ms BIGINT NOT NULL,
  scanned_mb DOUBLE NOT NULL,
  spilled_mb DOUBLE NOT NULL,
  execution_start_time TIMESTAMPTZ NOT NULL,
  execution_end_time TIMESTAMPTZ NOT NULL,
  duration_seconds DOUBLE NOT NULL,
  spill_pressure DOUBLE NOT NULL,
  queued BOOLEAN NOT NULL,
  queue_score DOUBLE NOT NULL,
  compile_score DOUBLE NOT NULL,
  spill_score DOUBLE NOT NULL,
  scan_score DOUBLE NOT NULL,
  PRIMARY KEY(query_id, arrival_timestamp)
);

-- ------------------------------------------------------------
-- Per-query diagnostic scores table (makes UI queries fast)
-- ------------------------------------------------------------
CREATE TABLE IF NOT EXISTS query_metrics_scores (
  query_id VARCHAR NOT NULL,
  arrival_timestamp TIMESTAMPTZ NOT NULL,
  deployment_type VARCHAR NOT NULL,
  instance_id VARCHAR,
  queue_score DOUBLE NOT NULL,
  compile_score DOUBLE NOT NULL,
  spill_score DOUBLE NOT NULL,
  scan_score DOUBLE NOT NULL,
  PRIMARY KEY(query_id, arrival_timestamp)
);

-- ------------------------------------------------------------
-- Overlap-aware 5-minute bucket tables
-- ------------------------------------------------------------
CREATE TABLE IF NOT EXISTS query_metrics_bucket_deployment_5m (
  deployment_type VARCHAR NOT NULL,
  window_start TIMESTAMPTZ NOT NULL,
  running_count DOUBLE NOT NULL,
  queued_count DOUBLE NOT NULL,
  scanned_mb DOUBLE NOT NULL,
  spilled_mb DOUBLE NOT NULL,
  spill_pressure DOUBLE NOT NULL,
  PRIMARY KEY(deployment_type, window_start)
);

CREATE TABLE IF NOT EXISTS query_metrics_bucket_instance_5m (
  deployment_type VARCHAR NOT NULL,
  instance_id VARCHAR NOT NULL,
  window_start TIMESTAMPTZ NOT NULL,
  running_count DOUBLE NOT NULL,
  scanned_mb DOUBLE NOT NULL,
  spilled_mb DOUBLE NOT NULL,
  PRIMARY KEY(deployment_type, instance_id, window_start)
);

-- ------------------------------------------------------------
-- Legacy rollups (kept for compatibility with older UI/page)
-- ------------------------------------------------------------
CREATE TABLE IF NOT EXISTS query_metrics_rollups (
  window_start TIMESTAMPTZ NOT NULL,
  deployment_type VARCHAR NOT NULL,
  avg_execution_duration_ms DOUBLE NOT NULL,
  p95_execution_duration_ms DOUBLE NOT NULL,
  query_count BIGINT NOT NULL,
  PRIMARY KEY(window_start, deployment_type)
);

-- ------------------------------------------------------------
-- Views for UI
-- ------------------------------------------------------------

-- Deployment history for charts (last N minutes is filtered in UI query)
CREATE OR REPLACE VIEW v_deployment_5m_history AS
SELECT
  deployment_type,
  window_start,
  running_count,
  queued_count,
  scanned_mb,
  spilled_mb,
  spill_pressure
FROM query_metrics_bucket_deployment_5m;

-- Latest deployment bucket for Pressure Reader (UI chooses deployment_type)
CREATE OR REPLACE VIEW v_deployment_5m_latest AS
SELECT *
FROM v_deployment_5m_history
QUALIFY window_start = max(window_start) OVER (PARTITION BY deployment_type);

-- Instance history for instance utilization chart
CREATE OR REPLACE VIEW v_instance_5m_history AS
SELECT
  deployment_type,
  instance_id,
  window_start,
  running_count,
  scanned_mb,
  spilled_mb
FROM query_metrics_bucket_instance_5m;

-- Recent processed events (for dashboard tables)
CREATE OR REPLACE VIEW v_recent_processed AS
SELECT
  query_id,
  deployment_type,
  instance_id,
  arrival_timestamp,
  execution_start_time,
  execution_end_time,
  queue_duration_ms,
  compile_duration_ms,
  execution_duration_ms,
  scanned_mb,
  spilled_mb,
  spill_pressure,
  queued,
  queue_score,
  compile_score,
  spill_score,
  scan_score
FROM query_metrics_processed;

-- "Problem queries" diagnostics view (simple ranking; UI can filter window)
CREATE OR REPLACE VIEW v_top_problem_queries AS
SELECT
  s.query_id,
  s.arrival_timestamp,
  s.deployment_type,
  s.instance_id,
  s.queue_score,
  s.compile_score,
  s.spill_score,
  s.scan_score,
  (0.35 * s.queue_score + 0.20 * s.compile_score + 0.45 * s.spill_score) AS pressure_score
FROM query_metrics_scores s;